#!/bin/bash
# filepath: /home/andre/Repositories/dotfiles_private/home/programs/src/monitor/ip_lan

# Usage: ./ip_lan [iface]

if [[ -n "$1" ]]; then
    iface="$1"
    # Check if the interface exists and has an IPv4 address
    ipaddr=$(ip -4 addr show "$iface" 2>/dev/null | grep -oP '(?<=inet\s)\d+(\.\d+){3}')
    if [[ -z "$ipaddr" ]]; then
        echo "Unknown device '$iface'"
        exit 1
    fi
else
    iface=$(ip -4 addr show | awk '/inet / && $2 !~ /^127\./ {print $NF; exit}')
    ipaddr=$(ip -4 addr show "$iface" | grep -oP '(?<=inet\s)\d+(\.\d+){3}')
fi

# Try to get speed using ethtool (wired)
raw_speed=$(ethtool "$iface" 2>/dev/null | awk -F': ' '/Speed:/ {print $2}')
speed="unknown"
if [[ "$raw_speed" =~ ([0-9]+)Mb/s ]]; then
    speed="${BASH_REMATCH[1]} Mbit/s"
elif [[ "$raw_speed" =~ ([0-9]+)Gb/s ]]; then
    speed="$((BASH_REMATCH[1] * 1000)) Mbit/s"
fi

# If speed is still unknown, try iwconfig for wireless Bit Rate
if [[ "$speed" == "unknown" ]]; then
    iwconfig_out=$(iwconfig "$iface" 2>/dev/null)
    iw_speed=$(echo "$iwconfig_out" | awk -F'=' '/Bit Rate/ {print $2}' | awk '{print $1, $2}')
    if [[ -n "$iw_speed" ]]; then
        # Replace Mb/s with Mbit/s for consistency
        speed=$(echo "$iw_speed" | sed 's/Mb\/s/Mbit\/s/')
    fi
fi

echo "$ipaddr ($speed)"