#!/bin/bash

# First time install with no repo setup
[ ! -d "$HOME/Repositories/" ] && mkdir -p $HOME/.Repositories
[ ! -d "$HOME/Repositories/dotfiles" ] || [ ! -d "$HOME/Repositories/dotfiles_private " ] &&
    git clone git@github.com:AndreasBrostrom/dotfiles.git &&
    bash $HOME/Repositories/dotfiles/install &&
    exit 0

# Installation starts
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
cd $SCRIPT_DIR
echo -e "\033[34;1mInstalling $(basename $SCRIPT_DIR)...\033[0m"

if [ -d $SCRIPT_DIR/home ]; then 
    echo -e "\033[1mLinking up home\033[0m"
    cd $SCRIPT_DIR/home
    for FILE in $(rg --files --hidden); do
        echo -e " \033[2mCreating softlink for $FILE\033[0m"
        [ ! -d $(dirname "$HOME/$FILE") ] && mkdir -p $(dirname "$HOME/$FILE")
        ln -sf "$SCRIPT_DIR/home/$FILE" "$HOME/$FILE"
    done
fi

if [ -d $SCRIPT_DIR/bin ]; then 
    echo -e "\033[1mInstall bin scripts\033[0m"
    cd $SCRIPT_DIR/bin
    for FILE in $(rg --files --hidden); do
        echo -e " \033[2mCopying $FILE\033[0m"
        sudo cp -f $FILE /usr/bin/$FILE
    done

    echo -e "\033[1mSetting up aliases\033[0m"
    cd /usr/bin/
    sudo ln -sf terminal term
    sudo ln -sf terminal gnome-terminal
    sudo ln -sf terminal default-terminal
fi

echo -e "\033[1mAdding custom conky\033[0m"
[ ! -d "/usr/share/conky/" ] && mkdir -p /usr/share/conky/
sudo cp -rf $SCRIPT_DIR/usr/share/conky/* /usr/share/conky/.

echo -e " \033[2mFixing SSH permissions\033[0m"
chmod 700 $HOME/.ssh
chmod 600 $HOME/.ssh/config
chmod 600 $HOME/.ssh/authorized_keys
chmod 600 $HOME/.ssh/*id_rsa
chmod 644 $HOME/.ssh/*.pub

# Get tools folder if non exist
if [ ! -d $SCRIPT_DIR/../Tools ]; then
    cd $SCRIPT_DIR/..
    git clone git@github.com:AndreasBrostrom/Tools.git
fi

if [ -d $SCRIPT_DIR/../Tools ]; then
    echo -e "\033[34;1mCopying scripts from Tools\033[0m"
    cd $SCRIPT_DIR/../Tools/ScriptsLinux
    [ ! -d "$HOME/.bin" ] && mkdir -p $HOME/.bin
    EXISTING=($(ls /usr/bin/))
    for FILE in $(rg --files --hidden); do
        if [[ " ${EXISTING[*]} " =~ " ${FILE} " ]]; then
            echo -e " \033[2mScript "$FILE" already pressent in /usr/bin skipping\033[0m"
            continue
        fi
        echo -e " \033[2mCopying $FILE\033[0m"
        cp -f $FILE $HOME/.bin/$FILE
    done
fi

# Get ssh folder if non exist
if [ ! -d $SCRIPT_DIR/../secure ]; then
    cd $SCRIPT_DIR/..
    git clone git@github.com:AndreasBrostrom/secure.git
fi

# ssh configs
if [ -d $SCRIPT_DIR/../secure/ssh ]; then
    echo -e "\033[1mHome secret from secure\033[0m"
    cd $SCRIPT_DIR/../secure/ssh
    [ ! -d "$HOME/.ssh" ] && mkdir -p $HOME/.ssh
    EXISTING=($(ls $HOME/.ssh))
    for FILE in $(rg --files --hidden); do
        #if [[ " ${EXISTING[*]} " =~ " ${FILE} " ]]; then
        #    echo -e " \033[2mFile "$FILE" already pressent in .ssh skipping\033[0m"
        #    continue
        #fi
        echo -e " \033[2mCopying $FILE\033[0m"
        cp -f $FILE $HOME/.ssh/$FILE
    done
    echo -e " \033[2mFixing SSH permissions to possibly new files\033[0m"
    chmod 700 $HOME/.ssh
    chmod 600 $HOME/.ssh/config
    chmod 600 $HOME/.ssh/authorized_keys
    chmod 600 $HOME/.ssh/*id_rsa
    chmod 644 $HOME/.ssh/*.pub
fi

# If not i3 remove the i3 configs
echo -e "\033[1mChecking desktop enviroment\033[0m"
if [ ! "$XDG_CURRENT_DESKTOP" == "i3" ]; then
    echo -e " \033[2mi3 not used removing configs.\033[0m"
    rm -rf $HOME/.i3
    rm -rf $HOME/.config/i3status
    rm -rf $HOME/.config/i3-scrot.conf
    
    rm -f  /bin/start_conky_evul
    rm -rf /usr/share/conky
fi